<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HOI4 Tarzı 1936 Dünya Strateji Oyunu</title>
<style>
  body {
    margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #222;
    color: #eee;
    overflow-x: hidden;
  }
  #container {
    display: flex;
    height: 100vh;
    user-select: none;
  }
  #map-container {
    flex: 2;
    position: relative;
    background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/BlankMap-World6.svg/2000px-BlankMap-World6.svg.png') no-repeat center center;
    background-size: contain;
    border-right: 2px solid #444;
  }
  #map-svg {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  }
  .country-shape {
    fill-opacity: 0.3;
    stroke: #888;
    stroke-width: 1;
    cursor: pointer;
    transition: fill-opacity 0.3s;
  }
  .country-shape:hover {
    fill-opacity: 0.6;
  }
  .selected-country {
    stroke: #fff !important;
    stroke-width: 3;
    fill-opacity: 0.9 !important;
  }
  #sidebar {
    flex: 1;
    background: #333;
    display: flex;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
  }
  h1, h2 {
    margin: 5px 0 10px 0;
    font-weight: 700;
  }
  .section {
    margin-bottom: 20px;
  }
  button {
    background: #555;
    border: none;
    color: #eee;
    padding: 8px 12px;
    margin: 5px 0;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
  }
  button:hover {
    background: #777;
  }
  #log {
    background: #111;
    color: #ddd;
    height: 150px;
    overflow-y: scroll;
    font-family: monospace;
    padding: 5px;
    border-radius: 4px;
  }
  .resource {
    margin: 5px 0;
  }
  .focus-tree {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #555;
    background: #222;
    padding: 5px;
    border-radius: 4px;
  }
  .focus {
    border-bottom: 1px solid #444;
    padding: 4px 2px;
    cursor: pointer;
  }
  .focus.locked {
    color: #888;
    cursor: not-allowed;
  }
  .focus.completed {
    color: #0f0;
  }
  .diplomacy-lists div {
    margin-bottom: 5px;
  }
  .diplomacy-positive {
    color: #4caf50;
  }
  .diplomacy-negative {
    color: #f44336;
  }
  .production-queue {
    max-height: 120px;
    overflow-y: auto;
    background: #222;
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #555;
  }
  .production-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .production-item button {
    padding: 0 6px;
    background: #a33;
  }
  .production-item button:hover {
    background: #c55;
  }
  #war-info {
    background: #222;
    border-radius: 4px;
    padding: 6px;
    margin-top: 10px;
  }
  #war-info p {
    margin: 4px 0;
  }
</style>
</head>
<body>

<div id="container">
  <div id="map-container">
    <svg id="map-svg" viewBox="0 0 2000 1001" preserveAspectRatio="xMidYMid meet"></svg>
  </div>
  <div id="sidebar">
    <h1 id="country-name">Ülke Seçiniz</h1>
    <div class="section" id="resources-section">
      <h2>Kaynaklar</h2>
      <div class="resource" id="res-manpower"></div>
      <div class="resource" id="res-steel"></div>
      <div class="resource" id="res-oil"></div>
      <div class="resource" id="res-factories"></div>
    </div>
    <div class="section" id="focus-section">
      <h2>Odak Ağacı</h2>
      <div class="focus-tree" id="focus-tree"></div>
    </div>
    <div class="section" id="production-section">
      <h2>Üretim</h2>
      <button id="btn-build-civilian">Sivil Fabrika İnşa Et (30 Çelik, 3 Ay)</button>
      <button id="btn-build-military">Askeri Fabrika İnşa Et (50 Çelik, 4 Ay)</button>
      <button id="btn-build-naval">Deniz Fabrikası İnşa Et (40 Çelik, 4 Ay)</button>
      <div class="production-queue" id="production-queue"></div>
    </div>
    <div class="section" id="army-section">
      <h2>Ordu</h2>
      <div id="army-info"></div>
      <button id="btn-train-infantry">Piyade Eğit (10 İşgücü → 5 Piyade)</button>
      <button id="btn-produce-tank">Tank Üret (5 Askeri Fabrika + 30 Çelik → 2 Tank)</button>
      <button id="btn-produce-plane">Uçak Üret (3 Askeri Fabrika + 20 Çelik → 3 Uçak)</button>
      <button id="btn-produce-ship">Gemi İnşa Et (4 Deniz Fabrikası + 40 Çelik → 1 Gemi)</button>
    </div>
    <div class="section" id="diplomacy-section">
      <h2>Diplomasi</h2>
      <div class="diplomacy-lists" id="diplomacy-info"></div>
      <select id="war-target-select"></select>
      <button id="btn-declare-war" disabled>Savaş İlan Et</button>
      <div id="war-info"></div>
    </div>
    <div class="section" id="log-section">
      <h2>Log</h2>
      <div id="log"></div>
    </div>
    <button id="btn-advance-month" style="margin-top: auto; background:#2c3e50; font-weight:bold;">1 Ay İlerle</button>
  </div>
</div>

<script>
/* ========= Temel Veri ========= */
const countriesData = {
  GER: { name: "Almanya", color: "#bb3333", manpower: 650, steel: 120, oil: 90, factories: { military: 18, civilian: 12, naval: 10 }, army: { infantry: 70, tanks: 25, planes: 30, ships: 18 }, diplomacy: { allies: ["ITA"], enemies: ["FRA", "ENG", "SOV"], neutral: ["POL", "HUN"] }, productionQueue: [], focuses: [] },
  FRA: { name: "Fransa", color: "#3555aa", manpower: 600, steel: 90, oil: 70, factories: { military: 16, civilian: 14, naval: 12 }, army: { infantry: 80, tanks: 10, planes: 20, ships: 25 }, diplomacy: { allies: ["ENG"], enemies: ["GER"], neutral: ["BEL", "SUI"] }, productionQueue: [], focuses: [] },
  ENG: { name: "İngiltere", color: "#aabbcc", manpower: 700, steel: 110, oil: 85, factories: { military: 20, civilian: 18, naval: 15 }, army: { infantry: 60, tanks: 20, planes: 40, ships: 35 }, diplomacy: { allies: ["FRA", "USA"], enemies: ["GER"], neutral: ["IRE"] }, productionQueue: [], focuses: [] },
  ITA: { name: "İtalya", color: "#cc6633", manpower: 450, steel: 60, oil: 40, factories: { military: 12, civilian: 9, naval: 8 }, army: { infantry: 40, tanks: 15, planes: 18, ships: 12 }, diplomacy: { allies: ["GER"], enemies: ["FRA", "ENG"], neutral: [] }, productionQueue: [], focuses: [] },
  SOV: { name: "SSCB", color: "#cc4444", manpower: 900, steel: 140, oil: 100, factories: { military: 22, civilian: 18, naval: 14 }, army: { infantry: 90, tanks: 35, planes: 40, ships: 20 }, diplomacy: { allies: [], enemies: ["GER"], neutral: ["MNG"] }, productionQueue: [], focuses: [] },
  USA: { name: "ABD", color: "#4a90e2", manpower: 800, steel: 130, oil: 110, factories: { military: 20, civilian: 20, naval: 18 }, army: { infantry: 60, tanks: 30, planes: 40, ships: 25 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  POL: { name: "Polonya", color: "#dd3333", manpower: 300, steel: 50, oil: 30, factories: { military: 10, civilian: 7, naval: 5 }, army: { infantry: 30, tanks: 5, planes: 5, ships: 3 }, diplomacy: { allies: [], enemies: ["GER", "SOV"], neutral: [] }, productionQueue: [], focuses: [] },
  JAP: { name: "Japonya", color: "#cc5555", manpower: 700, steel: 100, oil: 80, factories: { military: 18, civilian: 12, naval: 14 }, army: { infantry: 65, tanks: 25, planes: 35, ships: 20 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  AUS: { name: "Avusturya", color: "#aa8833", manpower: 250, steel: 40, oil: 20, factories: { military: 8, civilian: 6, naval: 4 }, army: { infantry: 20, tanks: 4, planes: 3, ships: 2 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  HUN: { name: "Macaristan", color: "#bb9933", manpower: 250, steel: 35, oil: 15, factories: { military: 8, civilian: 7, naval: 4 }, army: { infantry: 22, tanks: 6, planes: 3, ships: 3 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  BEL: { name: "Belçika", color: "#6677aa", manpower: 200, steel: 30, oil: 20, factories: { military: 7, civilian: 5, naval: 3 }, army: { infantry: 15, tanks: 3, planes: 2, ships: 1 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  SUI: { name: "İsviçre", color: "#999999", manpower: 150, steel: 20, oil: 15, factories: { military: 5, civilian: 5, naval: 0 }, army: { infantry: 10, tanks: 2, planes: 1, ships: 0 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  MNG: { name: "Moğolistan", color: "#885522", manpower: 180, steel: 15, oil: 10, factories: { military: 4, civilian: 4, naval: 0 }, army: { infantry: 12, tanks: 2, planes: 1, ships: 0 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  IRE: { name: "İrlanda", color: "#44aa44", manpower: 150, steel: 25, oil: 10, factories: { military: 5, civilian: 4, naval: 2 }, army: { infantry: 12, tanks: 3, planes: 2, ships: 1 }, diplomacy: { allies: [], enemies: [], neutral: [] }, productionQueue: [], focuses: [] },
  // Ek daha fazla ülke eklenebilir
};

const countries = JSON.parse(JSON.stringify(countriesData));

const countryPolygons = {
  GER: "M530,290 L560,285 L580,295 L610,280 L620,320 L600,350 L570,340 L540,330 Z",
  FRA: "M480,320 L500,315 L520,320 L530,350 L520,360 L500,360 L480,340 Z",
  ENG: "M450,280 L470,275 L490,290 L490,310 L470,320 L450,300 Z",
  ITA: "M540,360 L560,350 L570,370 L560,380 L540,370 Z",
  SOV: "M700,300 L740,290 L780,320 L760,360 L720,370 L690,350 Z",
  USA: "M150,350 L180,340 L190,360 L170,370 L150,360 Z",
  POL: "M580,300 L600,290 L610,310 L590,320 L570,310 Z",
  JAP: "M850,350 L870,340 L880,360 L860,370 Z",
  AUS: "M580,370 L600,360 L620,380 L600,390 Z",
  HUN: "M600,320 L620,310 L630,330 L610,340 Z",
  BEL: "M510,310 L530,300 L540,320 L520,330 Z",
  SUI: "M560,330 L570,320 L580,330 L570,340 Z",
  MNG: "M760,320 L780,310 L790,320 L780,330 Z",
  IRE: "M430,280 L440,275 L450,290 L440,295 Z",
  // Ek daha fazla coğrafi şekil eklenebilir
};

/* ========== Odak Ağacı Oluşturucu ========== */
function generateFocusesForCountry(code) {
  const baseFocuses = [
    { id: "industry_boost", title: "Sanayi Artışı", desc: "Fabrikalarınızı artırır.", cost: 1 },
    { id: "military_expansion", title: "Ordu Genişletme", desc: "Askeri güç arttırılır.", cost: 1 },
    { id: "naval_build_up", title: "Donanma Güçlendirme", desc: "Deniz gücünü arttırır.", cost: 1 },
    { id: "diplomatic_push", title: "Diplomatik Girişimler", desc: "Diplomasiyi kuvvetlendirir.", cost: 1 },
    { id: "research_focus", title: "Araştırma Yatırımları", desc: "Teknoloji gelişimi hızlanır.", cost: 1 },
  ];
  // Aynı base odakları kullanarak ülkeye özgü varyasyonlar yapabiliriz
  let focuses = [];
  for(let i=0; i<20; i++) {
    const base = baseFocuses[i % baseFocuses.length];
    focuses.push({
      id: base.id + "_" + i,
      title: `${base.title} ${i+1}`,
      desc: base.desc,
      cost: base.cost,
      completed: false,
      locked: i > 0, // İlk focus açık, sonrası kilitli
      dependencies: i > 0 ? [base.id + "_" + (i-1)] : []
    });
  }
  return focuses;
}

/* ========== Global Değişkenler ========== */
let selectedCountry = "GER";  // Kullanıcı seçtiği ülke
let currentMonth = 1;
let currentYear = 1936;
let warActive = false;
let warData = null;  // Savaş verisi
let logEl;

/* ========== Yardımcı Fonksiyonlar ========== */
function log(message) {
  const nowStr = `${currentYear}-${String(currentMonth).padStart(2,"0")}`;
  const entry = document.createElement("div");
  entry.textContent = `[${nowStr}] ${message}`;
  logEl.prepend(entry);
}

function updateDateDisplay() {
  document.getElementById("country-name").textContent = `${countries[selectedCountry].name} - ${currentYear} / ${currentMonth}`;
}

function getCountryByCode(code) {
  return countries[code];
}

/* ========== Harita Oluşturma ========== */
const mapSVG = document.getElementById("map-svg");

function drawMap() {
  mapSVG.innerHTML = ""; // Temizle
  for(const code in countries) {
    const country = countries[code];
    const polygon = document.createElementNS("http://www.w3.org/2000/svg", "path");
    polygon.setAttribute("d", countryPolygons[code] || "");
    polygon.setAttribute("fill", country.color);
    polygon.classList.add("country-shape");
    if(code === selectedCountry) polygon.classList.add("selected-country");
    polygon.addEventListener("click", () => {
      if(code !== selectedCountry) {
        selectedCountry = code;
        updateUI();
        drawMap();
        log(`${countries[code].name} seçildi.`);
      }
    });
    mapSVG.appendChild(polygon);
  }
}

/* ========== Odak Ağacı Rendering ========== */
function renderFocusTree() {
  const focusContainer = document.getElementById("focus-tree");
  focusContainer.innerHTML = "";
  const country = getCountryByCode(selectedCountry);
  if (!country.focuses || country.focuses.length === 0) {
    country.focuses = generateFocusesForCountry(selectedCountry);
  }
  country.focuses.forEach(focus => {
    const div = document.createElement("div");
    div.classList.add("focus");
    if(focus.completed) div.classList.add("completed");
    if(focus.locked) div.classList.add("locked");
    div.title = focus.desc;
    div.textContent = focus.title;
    div.addEventListener("click", () => {
      if(focus.locked || focus.completed) return;
      // Kilitli odakların bağımlılıklarını kontrol et
      if(focus.dependencies.length > 0) {
        const depCompleted = focus.dependencies.every(depId => {
          const dep = country.focuses.find(f => f.id === depId);
          return dep && dep.completed;
        });
        if(!depCompleted) {
          alert("Bağımlılıklar tamamlanmadan bu odağı seçemezsiniz.");
          return;
        }
      }
      // Odak tamamlandı
      focus.completed = true;
      // Kilitlemeleri güncelle
      country.focuses.forEach(f => {
        if(f.dependencies.includes(focus.id)) f.locked = false;
      });
      log(`${country.name} odak '${focus.title}' tamamlandı.`);
      updateUI();
    });
    focusContainer.appendChild(div);
  });
}

/* ========== Üretim Rendering ve İşlemleri ========== */
const productionQueueEl = document.getElementById("production-queue");

function renderProduction() {
  productionQueueEl.innerHTML = "";
  const country = getCountryByCode(selectedCountry);
  country.productionQueue.forEach((item,i) => {
    const div = document.createElement("div");
    div.classList.add("production-item");
    div.textContent = `${item.type} (Kalan: ${item.remainingMonths} ay)`;
    const btn = document.createElement("button");
    btn.textContent = "X";
    btn.title = "İptal Et";
    btn.addEventListener("click", () => {
      country.productionQueue.splice(i,1);
      renderProduction();
      log(`${country.name} üretim kuyruğundan ${item.type} iptal edildi.`);
    });
    div.appendChild(btn);
    productionQueueEl.appendChild(div);
  });
}

function addProduction(type, costSteel, months, onComplete) {
  const country = getCountryByCode(selectedCountry);
  if(country.steel < costSteel) {
    alert("Yeterli çelik yok.");
    return false;
  }
  country.steel -= costSteel;
  country.productionQueue.push({ type, remainingMonths: months, onComplete });
  log(`${country.name} üretime ${type} ekledi.`);
  renderProduction();
  return true;
}

/* ========== Üretim Butonları ========== */
document.getElementById("btn-build-civilian").addEventListener("click", () => {
  addProduction("Sivil Fabrika", 30, 3, () => {
    const c = getCountryByCode(selectedCountry);
    c.factories.civilian++;
  });
});

document.getElementById("btn-build-military").addEventListener("click", () => {
  addProduction("Askeri Fabrika", 50, 4, () => {
    const c = getCountryByCode(selectedCountry);
    c.factories.military++;
  });
});

document.getElementById("btn-build-naval").addEventListener("click", () => {
  addProduction("Deniz Fabrikası", 40, 4, () => {
    const c = getCountryByCode(selectedCountry);
    c.factories.naval++;
  });
});

/* ========== Ordu Rendering ========== */
const armyInfo = document.getElementById("army-info");

function renderArmy() {
  const c = getCountryByCode(selectedCountry);
  armyInfo.innerHTML = `
    <p>Piyade: ${c.army.infantry}</p>
    <p>Tank: ${c.army.tanks}</p>
    <p>Uçak: ${c.army.planes}</p>
    <p>Gemi: ${c.army.ships}</p>
  `;
}

/* ========== Ordu Üretim Butonları ========== */
document.getElementById("btn-train-infantry").addEventListener("click", () => {
  const c = getCountryByCode(selectedCountry);
  if(c.manpower < 10) {
    alert("Yeterli işgücü yok.");
    return;
  }
  c.manpower -= 10;
  c.army.infantry += 5;
  log(`${c.name} 5 piyade eğitti.`);
  renderArmy();
});

document.getElementById("btn-produce-tank").addEventListener("click", () => {
  const c = getCountryByCode(selectedCountry);
  if(c.factories.military < 5 || c.steel < 30) {
    alert("Yeterli fabrika veya çelik yok.");
    return;
  }
  c.factories.military -= 5;
  c.steel -= 30;
  setTimeout(() => {
    c.army.tanks += 2;
    c.factories.military += 5;
    log(`${c.name} 2 tank üretti.`);
    renderArmy();
  }, 2000);
});

document.getElementById("btn-produce-plane").addEventListener("click", () => {
  const c = getCountryByCode(selectedCountry);
  if(c.factories.military < 3 || c.steel < 20) {
    alert("Yeterli fabrika veya çelik yok.");
    return;
  }
  c.factories.military -= 3;
  c.steel -= 20;
  setTimeout(() => {
    c.army.planes += 3;
    c.factories.military += 3;
    log(`${c.name} 3 uçak üretti.`);
    renderArmy();
  }, 2500);
});

document.getElementById("btn-produce-ship").addEventListener("click", () => {
  const c = getCountryByCode(selectedCountry);
  if(c.factories.naval < 4 || c.steel < 40) {
    alert("Yeterli fabrika veya çelik yok.");
    return;
  }
  c.factories.naval -= 4;
  c.steel -= 40;
  setTimeout(() => {
    c.army.ships += 1;
    c.factories.naval += 4;
    log(`${c.name} 1 gemi inşa etti.`);
    renderArmy();
  }, 3000);
});

/* ========== Üretim Güncelleme ========== */
function productionTick() {
  for(const code in countries) {
    const c = countries[code];
    if(c.productionQueue.length === 0) continue;
    const currentProd = c.productionQueue[0];
    currentProd.remainingMonths--;
    if(currentProd.remainingMonths <= 0) {
      const done = c.productionQueue.shift();
      done.onComplete?.();
      log(`${c.name} üretim tamamladı: ${done.type}`);
    }
  }
}

/* ========== Kaynak Güncelleme ========== */
function monthlyResourceUpdate() {
  for(const code in countries) {
    const c = countries[code];
    c.steel += c.factories.civilian * 2 + c.factories.military * 3;
    c.oil += c.factories.naval * 2;
    c.manpower += 50;
    if(c.manpower > 1000) c.manpower = 1000;
  }
}

/* ========== Diplomasi ve Savaş Sistemi ========== */
const diplomacyInfo = document.getElementById("diplomacy-info");
const warTargetSelect = document.getElementById("war-target-select");
const btnDeclareWar = document.getElementById("btn-declare-war");
const warInfo = document.getElementById("war-info");

let warDeclared = false;
let warBetween = null;

function renderDiplomacy() {
  diplomacyInfo.innerHTML = "";
  const c = getCountryByCode(selectedCountry);
  // İttifaklar
  let alliesText = "<div><b>İttifaklar:</b> ";
  if(c.diplomacy.allies.length === 0) alliesText += "Yok";
  else alliesText += c.diplomacy.allies.map(a => countries[a]?.name || a).join(", ");
  alliesText += "</div>";
  diplomacyInfo.insertAdjacentHTML("beforeend", alliesText);

  // Düşmanlar
  let enemiesText = "<div><b>Düşmanlar:</b> ";
  if(c.diplomacy.enemies.length === 0) enemiesText += "Yok";
  else enemiesText += c.diplomacy.enemies.map(e => countries[e]?.name || e).join(", ");
  enemiesText += "</div>";
  diplomacyInfo.insertAdjacentHTML("beforeend", enemiesText);

  // Nötrler
  let neutralText = "<div><b>Nötrler:</b> ";
  if(c.diplomacy.neutral.length === 0) neutralText += "Yok";
  else neutralText += c.diplomacy.neutral.map(n => countries[n]?.name || n).join(", ");
  neutralText += "</div>";
  diplomacyInfo.insertAdjacentHTML("beforeend", neutralText);

  // Savaş ilan edilebilecek hedefler
  warTargetSelect.innerHTML = "";
  const possibleTargets = Object.keys(countries).filter(code => code !== selectedCountry && !c.diplomacy.allies.includes(code));
  possibleTargets.forEach(code => {
    const opt = document.createElement("option");
    opt.value = code;
    opt.textContent = countries[code].name;
    warTargetSelect.appendChild(opt);
  });
  btnDeclareWar.disabled = possibleTargets.length === 0;
}

btnDeclareWar.addEventListener("click", () => {
  if(warDeclared) {
    alert("Zaten bir savaş devam ediyor.");
    return;
  }
  const attacker = getCountryByCode(selectedCountry);
  const defenderCode = warTargetSelect.value;
  if(!defenderCode) return alert("Savaş ilan etmek için bir hedef seçin.");
  const defender = getCountryByCode(defenderCode);

  // Savaş ilanı
  warDeclared = true;
  warBetween = { attacker: selectedCountry, defender: defenderCode, active: true };
  attacker.diplomacy.enemies.push(defenderCode);
  defender.diplomacy.enemies.push(selectedCountry);
  log(`${attacker.name} ${defender.name} ülkesine savaş ilan etti!`);
  warInfo.textContent = `Savaş: ${attacker.name} vs ${defender.name}`;
});

/* ========== Savaş Güncellemesi ========== */
function updateWar() {
  if(!warDeclared || !warBetween || !warBetween.active) return;

  const attacker = getCountryByCode(warBetween.attacker);
  const defender = getCountryByCode(warBetween.defender);

  const attackerPower = attacker.army.infantry + attacker.army.tanks * 3 + attacker.army.planes * 2 + attacker.army.ships * 2;
  const defenderPower = defender.army.infantry + defender.army.tanks * 3 + defender.army.planes * 2 + defender.army.ships * 2;

  if(attackerPower <= 0 || defenderPower <= 0) {
    warBetween.active = false;
    warDeclared = false;
    if(attackerPower > defenderPower) {
      log(`${attacker.name} savaşı kazandı!`);
      defender.steel = Math.max(0, defender.steel - 50);
      defender.manpower = Math.max(0, defender.manpower - 50);
    } else if(defenderPower > attackerPower) {
      log(`${defender.name} savaşı kazandı!`);
      attacker.steel = Math.max(0, attacker.steel - 50);
      attacker.manpower = Math.max(0, attacker.manpower - 50);
    } else {
      log("Savaş berabere bitti.");
    }
    warInfo.textContent = "Savaş bitti.";
    updateUI();
    return;
  }

  // Kayıplar hesapla
  const attackerLoss = Math.floor(defenderPower * 0.15);
  const defenderLoss = Math.floor(attackerPower * 0.15);

  attacker.army.infantry = Math.max(0, attacker.army.infantry - attackerLoss);
  defender.army.infantry = Math.max(0, defender.army.infantry - defenderLoss);

  log(`${attacker.name} ${attackerLoss} piyade kaybetti. ${defender.name} ${defenderLoss} piyade kaybetti.`);
}

/* ========== AI Karar Mekanizması ========== */
function aiMakeDecisions() {
  for(const code in countries) {
    if(code === selectedCountry) continue; // Kullanıcı yönetiyor

    const c = countries[code];

    // 1) Üretim kararı (rastgele ama belli mantıkla)
    if(c.productionQueue.length === 0) {
      const rand = Math.random();
      if(rand < 0.4 && c.steel >= 30) {
        c.productionQueue.push({ type: "Sivil Fabrika", remainingMonths: 3, onComplete: () => { c.factories.civilian++; log(`${c.name} (AI) sivil fabrika inşa etti.`); }});
        c.steel -= 30;
      } else if(rand < 0.7 && c.steel >= 50) {
        c.productionQueue.push({ type: "Askeri Fabrika", remainingMonths: 4, onComplete: () => { c.factories.military++; log(`${c.name} (AI) askeri fabrika inşa etti.`); }});
        c.steel -= 50;
      } else if(rand < 0.85 && c.steel >= 40) {
        c.productionQueue.push({ type: "Deniz Fabrikası", remainingMonths: 4, onComplete: () => { c.factories.naval++; log(`${c.name} (AI) deniz fabrikası inşa etti.`); }});
        c.steel -= 40;
      }
    }

    // 2) Ordu üretimi (işgücü ve kaynaklara göre)
    if(c.manpower > 20) {
      // %60 piyade, %20 tank, %20 uçak üretimi
      const prodRand = Math.random();
      if(prodRand < 0.6) {
        c.manpower -= 10;
        c.army.infantry += 5;
        log(`${c.name} (AI) 5 piyade eğitti.`);
      } else if(prodRand < 0.8 && c.factories.military >= 3 && c.steel >= 30) {
        c.factories.military -= 3;
        c.steel -= 30;
        setTimeout(() => {
          c.army.tanks += 2;
          c.factories.military += 3;
          log(`${c.name} (AI) 2 tank üretti.`);
        }, 1500);
      } else if(prodRand < 1 && c.factories.military >= 2 && c.steel >= 20) {
        c.factories.military -= 2;
        c.steel -= 20;
        setTimeout(() => {
          c.army.planes += 3;
          c.factories.military += 2;
          log(`${c.name} (AI) 3 uçak üretti.`);
        }, 2000);
      }
    }

    // 3) Diplomasi ve savaş kararları
    // Rastgele savaşa girme kararı, eğer düşman var ve ordu güçlü ise
    if(!warDeclared && c.diplomacy.enemies.length > 0) {
      const enemyCode = c.diplomacy.enemies[Math.floor(Math.random() * c.diplomacy.enemies.length)];
      const enemy = countries[enemyCode];
      if(enemy) {
        const cPower = c.army.infantry + c.army.tanks * 3;
        const ePower = enemy.army.infantry + enemy.army.tanks * 3;
        if(cPower > ePower * 1.2) {
          // Savaş ilan et
          warDeclared = true;
          warBetween = { attacker: code, defender: enemyCode, active: true };
          c.diplomacy.enemies.push(enemyCode);
          enemy.diplomacy.enemies.push(code);
          log(`${c.name} (AI) ${enemy.name} ülkesine savaş ilan etti!`);
          warInfo.textContent = `Savaş: ${c.name} vs ${enemy.name}`;
          break; // Tek savaş aynı anda
        }
      }
    }
  }
}

/* ========== Kaynak ve Ordu Güncelleme ========== */
function updateResourcesAndArmy() {
  monthlyResourceUpdate();
  productionTick();
  updateWar();
  aiMakeDecisions();
}

/* ========== UI Güncelleme ========== */
function updateResourcesUI() {
  const c = getCountryByCode(selectedCountry);
  document.getElementById("res-manpower").textContent = `İşgücü: ${c.manpower}`;
  document.getElementById("res-steel").textContent = `Çelik: ${c.steel}`;
  document.getElementById("res-oil").textContent = `Petrol: ${c.oil}`;
  document.getElementById("res-factories").textContent = `Fabrikalar - Askeri: ${c.factories.military}, Sivil: ${c.factories.civilian}, Deniz: ${c.factories.naval}`;
}

function updateUI() {
  updateDateDisplay();
  drawMap();
  renderFocusTree();
  renderProduction();
  renderArmy();
  renderDiplomacy();
  updateResourcesUI();
}

/* ========== Zaman İlerlemesi ========== */
document.getElementById("btn-advance-month").addEventListener("click", () => {
  currentMonth++;
  if(currentMonth > 12) {
    currentMonth = 1;
    currentYear++;
  }
  updateResourcesAndArmy();
  updateUI();
  log("1 ay ilerledi.");
});

/* ========== Başlangıç ========== */
logEl = document.getElementById("log");
updateUI();
log("Oyun başladı. 1936 yılı, Temmuz ayı.");

</script>

</body>
</html>
